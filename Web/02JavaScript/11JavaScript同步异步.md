# JavaScript同步异步


### 单线程

单线程就是：指一次只能完成一件任务。如果有多个任务，就必须排队，前面一个任务完成，再执行后面一个任务，以此类推。

js语言最大的特点既是单线程

同步任务执行完以后 才会执行异步任务

异步任务：定时器 计时器 事件 ajax nodejs的fs读写

```js
//同步任务从上往下执行
//异步任务 看谁执行的快 谁快谁先执行
//如果异步任务执行的时间相同 按照先后顺序 前面的先执行 后面的后执行

//如果 时间不同 耗费时间短的先执行 耗费时间长的后执行
console.log(1);
console.log(2);
setTimeout(function(){
    console.log(3);
},1000)
setInterval(function(){
    console.log(4)
},3000)
console.log(5);
console.log(6);
//1,2,5,6,3,4
```

```js
    var li = document.getElementsByTagName('li');
    for (var i = 0; i < li.length; i++) {
        //同步
        li[i].onclick = function () {
            console.log('for内部的' + i);//异步
        }
    }
    console.log('外部的' + i);
```

## 为什么js是单线程
JavaScript语言的一大特点就是单线程，也就是说，同一个时间只能做一件事。那么为什么JavaScript不能有多个线程呢？这样能提高效率啊

JavaScript的单线程，与它的用途有关。作为浏览器脚本语言，JavaScript的主要用途是与用户互动，以及操作DOM。这决定了它只能是单线程，否则会带来很复杂的同步问题。比如，假定JavaScript同时有两个线程，一个线程在某个DOM节点添加内容，另一个线程删除了这个节点，这时浏览器应该以哪个线程为准？

所以为了避免复杂性，从一诞生，JavaScript就是单线程，这已经成了这门语言的核心特征，将来也不会改变。

## 任务队列(task queue)

单线程就意味着，所有任务需要排队前一个任务结束，才会执行后一个任务。如果一个任务耗时很长，后一个任务就不得不一直等着。
```js
  function f1() {
        for (var i = 0; i <= 999; i++) {
            console.log('f1');
        }
    }

    function f2(){
        console.log('f2');
    }
    f1();
    f2();
```

此时，f1函数非常耗时，因为js是单线程的，只能等f1执行完以后，才能执行f2

如果排队是因为计算量大，CPU忙不过来，倒也算了，但是很多时候CPU是闲着的，因为IO设备（输入输出设备/用户的读写操作）很慢（比如Ajax操作从网络读取数据），不得不等着结果出来，再往下执行。

JavaScript语言的设计者意识到，这时主线程完全可以不管IO设备，挂起处于等待中的任务，先运行排在后面的任务。等到IO设备返回了结果，再回过头，把挂起的任务继续执行下去。

> 超时结账，只有一个收银，大家都在排队，
>
> 突然发现，有一个人口袋里偷了一瓶茅台，他还不承认，非说是自己的随身带的酒，不是偷的
>
> 结账出现了问题，怎么快速解决？让他去一边，先让后面的人结账，后面的人结完账了，再来处理这个出问题的人
>
> 来到一旁的人，就是进入了任务队列

## 同步任务&异步任务
所有的任务可以分为两种

一种是同步任务（synchronous）
另一种是异步任务（asychronous）

同步任务指的是：在主线程上排队执行的任务，只有前一个任务执行完毕，才能执行后一个任务

异步任务指的是：不进入主线程，而进入任务队列（task queue）的任务
只有任务队列通知主线程，某个异步任务可以执行了，该任务才会进入主线程执行

## 灵魂三连问

问：js为什么需要异步?

答：如果JS中不存在异步,只能自上而下执行（js是单线程的语言）,万一上一行解析时间很长,那么下面的代码就 会被阻塞。

对于用户而言,阻塞就意味着"卡死",这样就导致了很差的用户体验。 



问： js单线程又是如何实现异步的呢?
答：通过事件循环(event loop)实现'异步'。 

​                                        

问： 异步任务有哪些呢？ 

答：定时器、计时器、 事件、 Ajax操作、NodeJS中的fs文件读写 等。

## Event Loop事件循环

事件循环：只要主线程空（代表同步任务执行完了），就会去读取任务队列，这都是JavaScript的运行机制，整个过程会不断重复



假定：异步任务执行时出现一个同步任务，当前异步执行完后立刻执行同步任务	———————！！！————没有这种可能
## 代码分析

```js
    console.log('000');

    setTimeout(function(){
        console.log('111');
    },1000)

    setTimeout(function(){
        console.log('222');
    },500)
    
    setTimeout(function(){
        console.log('333');
    },0)

    console.log('444');
```


## js执行机制总结

###### js的执行机制：

js是一个单线程的语言，把所有的任务分类为同步任务和异步任务

在执行的时候首先判断js代码是同步还是异步，同步就进入主线程，异步就进入任务队列Event queue

同步任务进入主线程后一直执行（从上往下），直到主线程空闲时（表示同步任务执行完毕），此时才会去任务队列Event queue中查看是否有可执行的异步任务，如果有就将任务队列中的异步任务推入主线程中进行执行

异步任务执行的时候，如果执行的时间一样，从任务队列里面从上往下执行

如果时间不一样，时间短的先执行